<!DOCTYPE html>
<html lang="en">
    <head>
    </head>
    {% extends '../layout.html' %}
    {% block content %}
    <div class="starter-template-fluid">
          <script src="{{ static_url('jquery.min.js') }}"></script>
          <center><h3>Project {{ handler.session['current_project'] }} - Crawl</h3></center>
          <center><p>User can here crawl websites in order to map websites.</p><br></center>
                      
          <script>
          var ws = new WebSocket("ws://localhost:5567/websocket");

          function timeout() {
              setTimeout(function () {
                  ws.onopen()
                  timeout();
              }, 3000);
          }

          ws.onopen = function() {
            {% for uid, details in handler.session['units'].items() %}
              {% if 'task' in details %}
                ws.send('{{ escape(str(uid)) }}#{{ escape(details['task']) }}');
              {% end %}
            {% end %}
          };

          function updateTitleState (data) {
            document.getElementById('current' + data.status.uid).innerHTML = data.status.link;
            /*
            if (data.state != 'SUCCESS') {
              document.getElementById('currentCheck').innerHTML = data.status.url;
            }
            else {
              document.getElementById('currentCheck').innerHTML = "<font color='red'>Differences found : " + data.result + "</font>";
            */
          }

          ws.onmessage = function (evt) {
            if (evt != null) {
                var data = JSON.parse(evt.data);
                updateTitleState(data);
            }
            else {
                console.log('[ERROR] Nothing to consume from websocket.');
            }
          };
          timeout()
          $(window).on('load',function(){
            console.log('page loaded')
            //$('#myModal').modal('show');
            //$().status('toggle');
          });
          </script>
                      <div class="spinner-border text-warning active" role="status" id="spiin" display="inline">
                        <span class="sr-only active">Loading...</span>
                      </div>
            <a href="/api/v1/users/{{ handler.session['username'] }}/projects/{{ handler.session['current_project'] }}/crawl/stop_task/all" class="btn btn-secondary">Stop All</a></input>

            <button type="submit" class="btn btn-secondary" form="allTable">Crawl Selected
            <form method="post" id="allTable" action="/api/v1/users/{{ handler.session['username'] }}/projects/{{ handler.session['current_project'] }}/crawl/create_task"></button>

           <br>
           <br>
            <table class="table table-responsive-sm table-striped">
              <thead>
                  <tr>
                    <th>Base URL</th>
                    <th>Pages</th>
                    <th>Downloaded</th>
                    <th>Duration</th>
                    <th>Starting Path</th>
                    <th>Depth</th>
                    <th>Select</th>
                    <th>Action</th>
                    <th></th>
                  </tr>
              </thead>
              <tbody>
                  {% for uid, details in handler.session['units'].items() %}
                  <tr>
                    <th>{{ escape(str(details['url'])) }}</th>
                    <th>{{ escape(str(details['total'])) }}</th>
                    <th>{{ escape(str(details['downloaded_files'])) }}</th>
                    <th>{{ escape(str(details['duration'])) }}</th>
                    <th>
                        <div class="form-group">
                        <input type="text" class="form-control" id="startPath{{ escape(str(uid)) }}" placeholder="/" name="startPath{{ escape(str(uid)) }}">
                        </div>
                    </th>
                    <th>
                        <select class="form-control" name="depth{{ escape(uid) }}">
                          <option value="2">2</option>
                          <option value="4">4</option>
                          <option value="6">6</option>
                          <option selected="selected" value="8">8</option>
                          <option value="10">10</option>
                          <option value="12">12</option>
                          <option value="14">14</option>
                        </select>
                    </th>
                    <th>
                      <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectedCheck{{ escape(uid) }}" name="selectedCheck{{ escape(uid) }}">
                        </div>
                      </div>
                    </th>
                    <th>
                      {% if 'task' in details %}
                      <a href="/api/v1/users/{{ handler.session['username'] }}/projects/{{ handler.session['current_project'] }}/crawl/stop_task/{{ escape(str(details['task'])) }}" class="btn btn-outline-dark">Stop</a></input>
                      {% end %}
                    </th>
                    <th>
                      <!--
                      <form action="#" method="get" class="form-horizontal"><button type="submit" class="btn btn-outline-dark">Stop</button></input></form>
                      //-->
                    </th>
                    </tr>
                    <td colspan="9">
                      <div id="current{{ escape(uid) }}"></div>
                    </td>
	               {% end %}
              </tbody>
            </table>
           </form>
    </div>
    {% end %}
</html>