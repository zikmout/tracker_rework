{% extends '../../layout.html' %}
{% block content %}
<div class="starter-template-fluid">
      <br />
      <center><h3>Project {{ handler.session['current_project'] }} : Live alerts on content change</h3></center>

      <div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" id="myLargeModalLabel" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content" id="myLargeModalLabelContent">
            
          </div>
        </div>
      </div>

      <br>
        <div class="progress" name="liveViewProgress">
          <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" id="pct" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
        <br>
        <form action="/api/v1/users/{{ handler.session['username'] }}/projects/{{ handler.session['current_project'] }}/send_report" method="post" class="form-horizontal">
        <div class="form-inline">
          <div class="form-group mb-2">
            <input class="form-control" placeholder="Email" name="email">
            <input type="hidden", name="fromPage" value="live_view">
          </div>
          <div class="col">
            <button type="submit" class="btn btn-info mb-2">Send report</button></input>
          </div>
          </form>
          Remaining tasks:&nbsp;<font color="red"><div id="numberOfPendingTasks">{{ len(handler.session['tasks']['live_view']) }}</div></font>/{{ len(handler.session['tasks']['live_view']) }} (<font color="red"><div id="numberOfFailedTasks" onclick="showFailedTasksDetails()">0</div></font>&nbsp;failed)

        </div>
        

        <form action="/api/v1/users/{{ handler.session['username'] }}/projects/{{ handler.session['current_project'] }}/alerts/live/update" method="post" class="form-horizontal">
          <div class="form-inline">
              <input type="hidden", name="fromPage" value="live_view">
              <button type="submit" class="btn btn-info">Download updated pages</button></input>
              <!-- <button type="submit" class="btn btn-danger">Stop Live View task</button></input> -->
          </div>
        </form>

      {% if 'live_view' in handler.session['tasks'] %}
        {% for tasks in handler.session['tasks']['live_view']  %}
          <center><p class="lead" id="currentState{{ escape(str(tasks['id'])) }}"></p></center>
          <center><p class="lead" id="currentCheck{{ escape(str(tasks['id'])) }}"></p></center>
          <div id="changedContent{{ escape(str(tasks['id'])) }}"></div>
        {% end %}
      {% end %}
</div>
<script>
var counterDone = 0;
var counterDoneMaster = 0;
var counterFailureMaster = 0;
var failures = Array();
var failuresURL = Array();
var totalTaskNb = {{ len(handler.session['tasks']['live_view']) }};
var counterRemaining = totalTaskNb;

var ws = new WebSocket("ws://localhost:5567/websocket");
function timeout() {
    setTimeout(function () {
        ws.onopen();
        timeout();
        counterDone = 0;
    }, 3000);
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function getRandomArbitrary(min, max) {
  return Math.random() * (max - min) + min;
}

ws.onopen = function() {
  {% if 'live_view' in handler.session['tasks'] %}
    {% for tasks in handler.session['tasks']['live_view'] %}
        ws.send('{{ escape(str(tasks['id'])) }}');
    {% end %}
  {% end %}
};

function formatDiff(title, diff, nearest_link, all_links, type) {
  var i;
  var diffs = '';
  for (i = 0; i < diff.length; i++) {
      diffs += diff[i] + "<br>";
  }
  var firstPart = 
  "<div class='card border-" + type + " mb-3'>\
              <div class='card-header bg-transparent border-" + type + " text-" + type + "'><b>" + title + "</b></div>\
              <div class='card-body text-" + type + "'>\
                <p class='card-text'>" + diffs + "</p></div>\
              <div class='card-footer bg-transparent border-" + type + "'>";
  var lastPart = 
  "</div>\
  </div>";

  var middlePart = '';
  if (all_links != null && all_links != undefined) {
    if (all_links.length > 10) {
      middlePart = '-> too many links'
    }
    else {
      for (i = 0; i < all_links.length; i++) {
        middlePart += "<a href='" + all_links[i] + "' target='_blank' style='color: rgb(0,0,0)'/>" + all_links[i] + "</a><br>";
      }
    }
    for (i = 0; i < nearest_link.length; i++) {
      if (middlePart.includes(nearest_link[i]) == false) {
        middlePart = "<a href='" + nearest_link[i] + "' target='_blank' style='color: rgb(0,0,0)'/>" + nearest_link[i] + "</a><br>" + middlePart;
      }
    }
  }
  
  var fullDiff = firstPart + middlePart + lastPart;
  return fullDiff;
}

ws.onmessage = function (evt) {
   if (evt != null) {
       var data = JSON.parse(evt.data);


          //console.log(data.state);

       if (data.state == 'SUCCESS') {
          counterDone += 1;
       }
       if (data.state == 'FAILURE' && !failures.includes(data.current)) {
          failures.push(data.current);
          // urlFailed = {
          //   "url" : data.status.url,
          //   "info" : data.info
          // }
          urlFailed = {
            "state" : data.state,
            "status" : data.status
          }
          failuresURL.push(urlFailed);
          counterFailureMaster += 1;
          $('#numberOfFailedTasks').html(counterFailureMaster);
          // document.getElementById('numberOfFailedTasks').
       }

       if ((data.status.diff_pos != null && data.status.diff_pos != undefined && data.status.diff_pos.length > 0) || (data.status.diff_neg != null && data.status.diff_neg != undefined && data.status.diff_neg.length > 0)) {
          if (!document.getElementById(data.status.div)) {
            var title = document.createElement("H5");
            title.innerHTML = data.status.div;
            document.getElementById('changedContent' + data.task_id).append(title);
            var title = document.createElement("DIV");
            title.setAttribute("id", data.status.div);
            document.getElementById('changedContent' + data.task_id).appendChild(title);
            document.getElementById('changedContent' + data.task_id).insertAdjacentHTML('beforebegin', '<br><hr>');
            document.getElementById('changedContent' + data.task_id).insertAdjacentHTML('beforeend', '<hr>');
          }
          if (data.state == 'SUCCESS' && document.getElementById(data.status.div) && !document.getElementById(data.current.toString() + data.task_id)) {

            document.getElementById(data.status.div).insertAdjacentHTML('beforeend', "<h6><a href=" + data.status.url + " target='_blank'/>" + data.status.url + "</a></h6>");
            var ulTitle = document.createElement("div");
            ulTitle.setAttribute("id", data.current.toString() + data.task_id);
            document.getElementById(data.status.div).append(ulTitle);

            var div_pos = formatDiff("Added Content", data.status.diff_pos, data.status.nearest_link_pos, data.status.all_links_pos, 'success');
            var div_neg = formatDiff("Deleted Content", data.status.diff_neg, data.status.nearest_link_neg, data.status.all_links_neg, 'danger');

            if (data.status.diff_pos.length != 0) {
              document.getElementById(data.current.toString() + data.task_id).insertAdjacentHTML('beforeend', div_pos);
            }
            if (data.status.diff_neg.length != 0) {
            document.getElementById(data.current.toString() + data.task_id).insertAdjacentHTML('beforeend', div_neg);                
            }
          }
       }
       if (counterDone > counterDoneMaster) {
        counterDoneMaster = counterDone;
        updateProgressBar('#liveViewProgress', (Math.round(parseInt((counterDoneMaster) + parseInt(counterFailureMaster))/parseInt(totalTaskNb))*100));
        counterRemaining = totalTaskNb - counterDoneMaster;
        $('#numberOfPendingTasks').html(counterRemaining - counterFailureMaster);
       }
     }
 else {
  console.log('[ERROR] Nothing to consume from websocket.');
 }
};
timeout();
function updateProgressBar(divId, percent) {
  // if (percent <= 100) {
    $(divId).text(percent + '%');
    document.getElementById("pct").style.width = percent + '%';
    document.getElementById("pct").innerHTML = percent + '%';
  // }
}

function showFailedTasksDetails() {
  console.log('failed details clicked  !');
  $('#myLargeModalLabelContent').empty();
  for (i = 0; i < failuresURL.length; i++) {
    $('#myLargeModalLabelContent').append(failuresURL[i].state + ':' +  failuresURL[i].status + '<br>');
    console.log(failuresURL[i]);
  }
  if (failuresURL.length > 0) {
    $('#myLargeModalLabel').modal('show');
  }
}
</script>
{% end %}
{% block script %}
<script>
  $('button').click(function(){
     $('<div class="loading">Loading&#8230;</div>').prependTo(document.body);
  });
</script>
{% end %}
